image: docker:19.03

variables:
  DOCKER_DRIVER: overlay
  GIT_SUBMODULE_STRATEGY: normal

stages:
  - build

build_test_site:
  services:
    - docker:19.03-dind
  stage: build
  script:
    - docker build -f Dockerfile.branch .
    # }}}
  only:
    refs:
      - branches
    changes:
      - themes/*
  except:
    - master

theme_branch:
  image: alpine:latest
  stage: build
  script:
    - apk add --update git ruby
    - ruby .ci/theme-branch.rb
  only:
    - branches
  except:
    - master
# }}}

build_and_deploy:
  stage: build
  tags:
    - shell
  script:
    - hugo --verbose --minify
    - hugo deploy --log --verbose
  only:
    - master
